{% extends 'base.html' %}
{% load static %}
{% load sass_tags %}

{% block css %}
{% endblock %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Container-fluid starts-->
<div class="container-fluid">
    <div class="card-body">
        <div class="row shopping-wizard">
          <div class="col-12"> 
            <div class="row shipping-form g-5">
              <div class="col-xl-8 shipping-border">
                <div class="nav nav-pills horizontal-options shipping-options" id="cart-options-tab" role="tablist" aria-orientation="vertical"><a class="nav-link b-r-0 active" id="bill-wizard-tab" data-bs-toggle="pill" href="#bill-wizard" role="tab" aria-controls="bill-wizard" aria-selected="true"> 
                    <div class="cart-options">
                      <div class="stroke-icon-wizard"><i class="fa fa-comments-o"></i></div>
                      <div class="cart-options-content"> 
                        <h4>Campaign</h4>
                      </div>
                    </div></a><a class="nav-link b-r-0" id="ship-wizard-tab" data-bs-toggle="pill" href="#ship-wizard" role="tab" aria-controls="ship-wizard" aria-selected="false" disabled> 
                      <div class="cart-options">
                        <div class="stroke-icon-wizard"><i class="fa fa-phone"></i></div>
                        <div class="cart-options-content"> 
                          <h4>Contacts</h4>
                        </div>
                      </div>
                      </a><a class="nav-link b-r-0" id="payment-wizard-tab" data-bs-toggle="pill" href="#payment-wizard" role="tab" aria-controls="payment-wizard" aria-selected="false" disabled> 
                        <div class="cart-options">
                          <div class="stroke-icon-wizard"><i class="fa fa-user"></i></div>
                          <div class="cart-options-content"> 
                            <h4>Agent</h4>
                          </div>
                        </div></a><a class="nav-link b-r-0" id="finish-wizard-tab" data-bs-toggle="pill" href="#finish-wizard" role="tab" aria-controls="finish-wizard" aria-selected="false" disabled> 
                    <div class="cart-options">
                      <div class="stroke-icon-wizard"><i class="fa fa-check-square"></i></div>
                      <div class="cart-options-content"> 
                        <h4>Submit</h4>
                      </div>
                    </div></a></div>
                <div class="tab-content dark-field shipping-content" id="cart-options-tabContent">
                  <div class="tab-pane fade show active" id="bill-wizard" role="tabpanel" aria-labelledby="bill-wizard-tab" disabled>
                    <h3>Campaign Information </h3>
                    <p class="f-light">Fill up the following information </p>
                    <form class="row g-3 needs-validation" novalidate="">
                        <div class="col-sm-6">
                          <label class="form-label" for="campaignName">Campaign Name<span class="txt-danger">*</span></label>
                          <input class="form-control" id="campaignName" type="text" placeholder="Enter campaign name" required="">
                          <div class="valid-feedback">Looks good!</div>
                        </div>
                        
                        <div class="col-sm-6">
                          <label class="form-label" for="organisationName">Organisation Name<span class="txt-danger">*</span></label>
                          <select class="form-select" id="organisationName" required="">
                            {<!-- dynamically populate provider options -->}
                            {% for org in org_names %}
                               <option value="{{ org }}">{{ org }}</option>
                            {% endfor %}
                          </select>
                          <div class="valid-feedback">Looks good!</div>
                        </div>
                        
                        <div class="col-sm-6">
                          <label class="form-label" for="processType">Process Type<span class="txt-danger">*</span></label>
                          <select class="form-control" id="processType" required>
                            <option value="" disabled selected>Select process type</option>
                            <option value="RCM">RCM</option>
                            <option value="RETRIEVAL">RETRIEVAL</option>
                            <option value="OTHER">OTHER</option>
                          </select>
                          <div class="valid-feedback">Looks good!</div>
                        </div>
                        
                        <div class="col-sm-6">
                          <label class="form-label" for="provider">Provider<span class="txt-danger">*</span></label>
                          <select class="form-select" id="provider" required="">
                            {<!-- dynamically populate provider options -->}
                            {% for provider in telephony_providers_list %}
                               <option value="{{ provider.id }}">{{ provider.provider_name }}</option>
                            {% endfor %}
                          </select>
                          <div class="invalid-feedback">Please select a valid provider.</div>
                        </div>
                        
                        <div class="col-sm-6">
                          <label class="form-label" for="summarization_prompt">Summarization Prompt<span class="txt-danger">*</span></label>
                          <textarea class="form-control" id="summarization_prompt" rows="10" cols="100" placeholder="Instruction to describe about how a call should be summarized. Call will not be summarized if left blank."></textarea>
                        </div>                          
                        <br>
                        
                        <div class="row" style="margin-top: 1%;">
                          <div class="col-sm-4">
                              <div class="form-check form-switch">
                                <input class="form-check-input" id="showTranscript" type="checkbox" checked>
                                <label class="form-check-label " for="showTranscript">Show Transcript</label>
                              </div>
                            </div>
                            
                            <div class="col-sm-4">
                              <div class="form-check form-switch">
                                <input class="form-check-input" id="showRecording" type="checkbox" checked>
                                <label class="form-check-label" for="showRecording">Show Recording</label>
                              </div>
                            </div>
                          
                            <div class="col-sm-4">
                              <div class="form-check form-switch">
                                <input class="form-check-input" id="showNumbers" type="checkbox" checked>
                                <label class="form-check-label" for="showNumbers">Show Numbers</label>
                              </div>
                            </div>
                          </div>
                        <div class="col-12 text-end">
                          <button id="step1btn" type="button" onclick="validateStep1(event)" class="btn btn-primary">Proceed to Next<i class="fa fa-arrow-left proceed-next pe-2"></i></button>
                        </div>
                      </form>
                  </div>
                  <div class="tab-pane fade shipping-wizard" id="payment-wizard" role="tabpanel" aria-labelledby="payment-wizard-tab"   >
                    <h5 class="f-w-600">Agent Information</h5>
                    <p class="f-light">Select the agent for the calls</p>
                    <div class="shipping-title">
                      <h6 class="mb-2">Available Agents</h6>
                      <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#exampleModalgetbootstrap" data-whatever="@getbootstrap"> <i class="fa fa-plus-square f-20"></i></button>

                    </div>
                    <div class="row g-3"  >

                      <div class="col-xxl-4 col-sm-6" style="width: 100%;" > 
                        <div class="col-sm-6">
                            <label class="form-label" for="Agents">Agents<span class="txt-danger">*</span></label>
                            <select class="form-select" id="Agents" required="">
                              {% for agent in available_agents %}
                              <!-- dynamically populate Agents options -->
                              <option selected=""  value="{{agent.id}}">{{agent.agent_name}}</option>
                              {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a valid provider.</div>
                     </div>
                    <h5 class="f-w-600 mt-4 mb-2">Prompt</h5>
                      <div class="row shipping-method g-3">
                        <div class="col-12">
                          <label class="form-label" for="agentPrompt">Add variable in the prompt by using {variable_name} syntax.</label>
                          <h6> Available variables are: </h6><br>
                          <textarea class="form-control" id="availableVariabes"> </textarea>
                          <div id="agentPromptEditor" style="height: 200px; width: 100%; border: 1px solid #ddd;"></div>
                          <div class="invalid-feedback" id="promptError" style="display:none;">Invalid variables used in the prompt.</div>
                        </div>
                      </div>
                          
                     <h5 class="f-w-600 mt-4 mb-2">Voice</h5> 
                      <div class="col-sm-6">
                        <label class="form-label" for="voice">voice<span class="txt-danger">*</span></label>
                        <select class="form-select" id="voice" required="">
                          {% for voice in available_agents %}
                          <!-- dynamically populate Agents options -->
                          <option selected="" value="{{voice.voice.id}}">{{voice.voice.voice_name}}</option>
                          {% endfor %}
                        </select>
                        <div class="invalid-feedback">Please select a valid provider.</div>
                        </div>
                      </div>  

                      <div class="col-12 text-end">
                        <button id="step3btn" type="button" onclick="validateStep3(event)" class="btn btn-primary">Proceed to Next<i class="fa fa-arrow-left proceed-next pe-2"></i></button>
                      </div>
                    </div>
                  </div>
                  
                  <div class="tab-pane fade shipping-wizard" id="ship-wizard" role="tabpanel" aria-labelledby="ship-wizard-tab">
                    <h3>Contacts Information</h3>
                    <p class="f-light">Upload a csv file with "contact_number" as a column</p>
                    <div class="payment-info-wrapper">
                      <div class="row shipping-method g-3">
 
                        <div class="col-12">
                          <div class="card-wrapper border rounded-3 pay-info light-card">
 
                            <form class="row g-3 needs-validation" novalidate="">
                               
                              <div class="col-12"> 
                                <label class="form-label" for="formFile3">Upload Contacts</label>
                                <input class="form-control" id="formFile3" type="file" aria-label="file example" required="">
                                <div class="invalid-feedback">Invalid form file selected</div>
                              </div>
                              <div class="col-12">
                                <div class="form-check">
                                  <input class="form-check-input" id="invalidCheck-c" type="checkbox" value="" required="">
                                  <label class="form-check-label" for="invalidCheck-c">All the above information is correct</label>
                                  <div class="invalid-feedback">You must agree before submitting.</div>
                                </div>
                              </div>
                            </form>
                          </div>
                        </div>
                        <div class="col-12">

                        </div>
                        <div class="col-12 text-end">
                          <button id="step2btn" type="button" onclick="validateStep2(event)" class="btn btn-primary">Proceed to Next<i class="fa fa-arrow-left proceed-next pe-2"></i></button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="tab-pane fade shipping-wizard finish-wizard1" id="finish-wizard" role="tabpanel" aria-labelledby="finish-wizard-tab" disabled>
                    <div class="order-confirm"><img src="{% static 'assets/images/gif/successful.gif' %}" alt="popper">
                      <h5>Confirm the Campaign details before submitting.</h5>
                      <p class="mb-0">The created Campaign can be accessed in Campaign Managent page.</p>
                    </br>
                      <!-- <p class="text-center f-w-600 mt-2">Order ID: <a class="text-decoration-underline" href="javascript:void(0)">GE34598 </a></p> -->
                      <div class="col-12 text-center">
                        <button id="step4btn" type="button" onclick="createCampaign(event)" class="btn btn-primary">Save <i class="icon-save"></i></i></button>
                      </div>
                    </div>


                  </div>
                </div>
              </div>
              <div class="col-xl-4"> 
                <div class="shipping-info">
                  <h4 class="f-w-600">Tools</h4>
                  <br>
                  <div class="overflow-auto">
                    <div class="card-body social-list filter-cards-view">
                       
                      <div class="d-flex"><img class="img-50 img-fluid m-r-20 rounded-circle" alt="" src="/zono/zonoapp/static/assets/images/user/3.jpg">
                        <div class="flex-grow-1"><span class="d-block">Agent Library</span><a href="{% url 'agent_create' %}">Add or update Agent</a></div>
                      </div>
                      <div class="d-flex"><img class="img-50 img-fluid m-r-20 rounded-circle" alt="" src="/zono/zonoapp/static/assets/images/user/10.jpg">
                        <div class="flex-grow-1"><span class="d-block">Voice Library</span><a href=" ">Add or update Voice</a></div>
                      </div>
                      <div class="d-flex"><img class="img-50 img-fluid m-r-20 rounded-circle" alt="" src="/zono/zonoapp/static/assets/images/user/11.png">
                        <div class="flex-grow-1"><span class="d-block">Manage Campaign</span><a href="{% url 'manage_campaign' %}">Update or Schedule Campaign</a></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Container-fluid Ends-->
        </div>
      </div>
</div>
<!-- Container-fluid Ends-->
 
<!-- Ace Editor codeblock -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js" integrity="sha512-GZ1RIgZaSc8rnco/8CXfRdCpDxRCphenIiZ2ztLy3XQfCbQUSCuk8IudvNHxkRA3oUg6q0qejgN/qqyG1duv5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Script block -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // csv related declarations 
  let columnNames ;
  let csvData;
  let rows;
  let contactList;
  let agent_prompt;


  // Function to show toast
  function showToast(type, message) {
    Swal.fire({
                title: 'Alert',
                text: message, // Dynamic message from Django
                icon: 'success',
                confirmButtonText: 'OK'
            });
    }
  // Function to validate the prompt
  function validatePrompt() {
    agent_prompt = editor.getValue();
    let regex = /{\s*([\w_]+)\s*}/g; // Regex to find variables in {}

    let match;
    let invalidVariables = [];

    while ((match = regex.exec(agent_prompt)) !== null) {
      let variable = match[1]; // Extract the variable name
      if (!columnNames.includes(variable)) {
        invalidVariables.push(variable); // Collect invalid variables
      }
    }
    if (!agent_prompt){
      return false;
    }

    if (invalidVariables.length > 0) {
      document.getElementById("promptError").style.display = 'block';
      editor.session.setAnnotations([{
        row: 0,
        column: 0,
        text: 'Invalid variables: ' + invalidVariables.join(', '),
        type: 'error' // Other types include 'info' and 'warning'
      }]);
      return false;
    } else {
      document.getElementById("promptError").style.display = 'none';
      editor.session.clearAnnotations();
      return true;
    }
  }

  // Initialize Ace Editor
  let editor = ace.edit("agentPromptEditor");
  editor.setTheme("ace/theme/monokai"); // You can choose other themes if needed
  editor.session.setMode("ace/mode/text"); // Set the mode to plain text

  
  // step1 validataion
  function validateStep1(e) {
    // e.preventDefault(); // Prevent the default form submission

    // validation logic. For example:
    const campaignName = $("#campaignName").val();
    const organisationName = $("#organisationName").val();
    const processType = $("#processType").val();
    const provider = $("#provider").val();
    const summarizationPrompt = $("#summarization_prompt").val();

    // Check if the required fields are filled (basic validation)
    if (campaignName && organisationName && processType && provider) {
        // alert("step1 clicked");

        // Move to step 2 by enabling the next tab and activating it
        $("#ship-wizard-tab").removeAttr("disabled");
        document.getElementById("ship-wizard-tab").click()

    } else {
        // Handle validation failure (e.g., show an alert or highlight invalid fields)
        alert("Please fill in all required fields.");
    }
  }

  // step2 validataion
    function validateStep2(e){
    // alert("step2 clicked")
    uploadedFile = $("#formFile3");
    
    if (uploadedFile){
      // Move to step 2 by enabling the next tab and activating it
        $("#payment-wizard-tab").removeAttr("disabled");
        document.getElementById("payment-wizard-tab").click()
    }else{
      alert("upload the contact list correctly")
    }
  
  }

  // step3 validataion
  function validateStep3(e){
    if (validatePrompt()) {
    // Proceed if validation passes
    console.log("Prompt is valid!");
    
    /// move to finish tab
    $("#finish-wizard-tab").removeAttr("disabled");
    document.getElementById("finish-wizard-tab").click()

    } else {
      console.log("Invalid prompt. Please fix errors.");
    }
  }

  // submit and save campaign
  function createCampaign(){
    event.preventDefault();
    // Prepare data to be sent
    let data = {
        agent: $('#Agents').val(),        // Assuming you're using the agent's ID
        campaign_name: $('#campaignName').val(),
        is_schedule: $('#isSchedule').is(':checked'),
        organisation_name: $('#organisationName').val(),
        summarization_prompt: $('#summarizationPrompt').val(),
        show_transcript: $('#showTranscript').is(':checked'),
        process_type: $('#processType').val(),
        contact_list:contactList,
        prompt:agent_prompt,
        provider: $('#provider').val(),  // Assuming you're using the provider's ID
        show_recording: $('#showRecording').is(':checked'),
        show_numbers: $('#showNumbers').is(':checked'),
        csrfmiddlewaretoken: '{{ csrf_token }}'  // Make sure you include CSRF token for Django
    };

    $.ajax({
        url: "{% url 'create_campaign' %}",
        type: 'POST',
        data: JSON.stringify(data),  // Convert the data to JSON
        contentType: 'application/json',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        success: function(response) {
            // Handle the successful response, maybe show a success message
            console.log("Campaign created successfully");
            // alert("Campaign created successfully!");
            showToast("success", "Campaign added successfully!");
        },
        error: function(xhr, status, error) {
            // Handle errors here
            console.error("Error creating campaign:", error);
            // alert("Error creating campaign: " + xhr.responseText);
            showToast("error", "Failed to add Agent! "+ error);
        }
     });
  }
      


  // file upload validation
  $('#formFile3').on('change', function(event) {
    const file = event.target.files[0];

    if (!file) {
      alert("Please select a file.");
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      csvData = e.target.result;
      rows = csvData.split('\n').map(row => row.split(','));

      if (rows.length < 1) {
        alert("The CSV file is empty or invalid.");
        return;
      }

      // Get header row and process column names
      const headerRow = rows[0];
      columnNames = $.map(headerRow, function(col) {
        return col.toLowerCase() ;
      });

      // Check for contact_number column
      console.log(columnNames)
      document.getElementById("availableVariabes").value=columnNames.join(' , ') //comma seprated list

      const phoneNumberIndex = headerRow.indexOf('contact_number');
      console.log(phoneNumberIndex)
      if (phoneNumberIndex === -1) {
        alert('CSV must contain a "contact_number" column.');
        return;
      }

      // Validate that contact_number column contains only 10-digit numbers
      const invalidNumbers = rows.slice(1).some(function(row) {
        const contactNumber = row[phoneNumberIndex]; // Get the contact number from the row
        console.log(contactNumber)
        // Check if contactNumber is defined and then trim and validate
        // if (contactNumber === undefined) {
        //   return true; // Treat as invalid if undefined
        // }
        
        // Trim and validate the contact number
        return !/^\d{10}$/.test(contactNumber.trim());
      });
      console.log(invalidNumbers)
      if (invalidNumbers) {
        alert('The "contact_number" column contains invalid numbers. All phone numbers must be 10 digits.');
        return;
      }

      // Store CSV data as JSON array of objects
      const data = $.map(rows.slice(1), function(row) {
        let obj = {};
        $.each(row, function(i, cell) {
          obj[columnNames[i]] = $.trim(cell);
        });
        return obj;
      });

      // Enable the proceed button after validation
      $('#proceedButton').prop('disabled', false);
      contactList = data
      console.log("Column Names: ", columnNames);
      console.log("File Data: ", data);
      alert('contacts upload successfull')

      // You can store the data in a global variable or handle it as needed
      window.csvData = data;
    };

    reader.readAsText(file);
  });
</script>

{% endblock %}

{% block scriptcontent %}

{% endblock %}