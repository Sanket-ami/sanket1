{% extends 'base.html' %}
{% load static %}
{% load sass_tags %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% block content %}

<div class="container-fluid mt-4" style="overflow-x: auto;">
    <h3 class="mb-4">Select Campaign</h3>

    <!-- Dropdown for selecting campaign -->
     <div class="mb-3">
        <form method="GET" action='{% url "list_call_logs" %}' style=" width: 30%; display: flex; ">
            <select class="form-select" id="campaignSelect" name="campaign_id">
                <option value="">----</option>
                {% for campaign in campaign_list %}
                <option value="{{ campaign.id }}" {% if campaign.id|stringformat:"s" == campaign_id|stringformat:"s" %}selected{% endif %}>
                    {{ campaign.campaign_name }}
                </option>
                {% endfor %}
            </select>
            <input type="hidden" name="page" value="{{ page }}">
            <input type="hidden" name="per_page" value="10">&nbsp;
            <input type="submit" class="btn btn-primary" value="Filter">
        </form>
    </div>

    <!-- Bootstrap Table for Call Logs -->
    <table class="table table-inverse table-striped dataTable" style="display: block; max-width: -moz-fit-content; max-width: fit-content; margin: 0 auto; overflow-x: auto; white-space: nowrap;" id="callLogsTable">
        <thead>
            <tr>
                {% if call_logs_data %}
                    {% for key in call_logs_data.0.keys %}
                    <th class="">{{ key }}</th>
                    {% endfor %}
                {% else %}
                    <th>No Data Available</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% if call_logs_data %}
                {% for log in call_logs_data %}
                <tr onclick="showDetails({{log}})" id="trigger-btn" data-bs-toggle="modal" data-bs-target="#myModal">
                    {% for value in log.values %}
                    <td>{{ value }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="{{ call_logs_data.0.keys|length }}">No logs available</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Pagination -->
    <br>
    <nav>
        
        <ul class="pagination pagination-primary pagin-border-primary">
            {% if paginated_logs.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?campaign_id={{ request.GET.campaign_id }}&page={{ paginated_logs.previous_page_number }}&per_page=10" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% endif %}
    
            {% for i in paginated_logs.paginator.page_range %}
            <li class="page-item {% if i == paginated_logs.number %}active{% endif %}">
                <a class="page-link" href="?campaign_id={{ request.GET.campaign_id }}&page={{ i }}&per_page=10">{{ i }}</a>
            </li>
            {% endfor %}
    
            {% if paginated_logs.has_next %}
            <li class="page-item">
                <a class="page-link" href="?campaign_id={{ request.GET.campaign_id }}&page={{ paginated_logs.next_page_number }}&per_page=10" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>

</div>
<!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal">
    Open modal
  </button> -->
<!-- Script -->
<!-- The Modal -->
<div class="modal" id="myModal" >
    <div class="modal-dialog modal-fullscreen" style="width: 40%; float:right;">
      <div class="modal-content">
  
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">Call Details</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
  
        <!-- Modal body -->
        <div class="modal-body position-relative">

            <button id="callDetailsDrawerHideBtn" type="button" data-drawer-hide="drawer-right-example" aria-controls="drawer-right-example" class="btn btn-link text-gray-400 position-absolute top-0 end-0 p-2">
                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path>
                </svg>
                <span class="visually-hidden">Close menu</span>
            </button>

            <div id="call_id_div">
                <span class="h5 fw-bold text-dark">Call ID</span><br>
                <span id="call_call_id" class="p-4 text-muted text-center"></span>
            </div>

            <div id="duration_div"><br>
                <span class="h5 fw-bold text-dark">Call Duration</span><br>
                <span id="call_duration" class="p-4 text-muted text-center"></span><br>
            </div>

            <div id="number_div"><br>
                <span class="h5 fw-bold text-dark">Payer Contact</span><br>
                <form id="payer_contact_form" class="d-flex flex-column align-items-center">
                    <input type="text" id="payer_contact" class="form-control text-center" placeholder="Enter contact information" required>
                    <input type="hidden" id="editNumberId" name="id" value="391"><br>
                    <!-- <button type="submit" class="btn btn-primary mt-2">Edit Number</button> -->
                </form><br>
            </div>

            <div id="audio_player_div">
                <span class="h5 fw-bold text-dark">Call Recording</span><br>
                <div id="loader" class="d-none">
                    <br>
                    <span class="p-4 text-muted text-center">Loading... <img src="{% static 'assets/images/ajax-loader.gif' %}" alt="Loading" class="inline-block"></span>
                </div><br>
                <audio id="call_recording_audio" controls src="blob:http://192.168.13.117:5000/6af63435-b177-4806-a351-abe685c37e40">
                    Your browser does not support the audio element.
                </audio><br>
                <span id="no_recording" class="text-muted text-center d-none">
                    No recording available for this call.
                </span><br>
            </div>

            <div id="loader" class="d-none d-flex justify-content-center align-items-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Loading...</span>
            </div>

            <div id="summary_div"> <br>
                <span class="h5 fw-bold text-dark">Call Summary</span><br>
                <button id="ediTranscriptBtn" class="btn btn-primary mt-2" onclick="editSummaryText(e)" style="border: 1px solid; padding: 1%;"> <i class="fa fa-edit" aria-hidden="true"> Edit </i></button>
                <span id="call_summary" class="p-4 text-muted text-center d-block">I called the medical records facility and spoke with an employee. The employee informed me that the records request for Paymaneh Baharmast was received and is currently under processing. They could not provide an exact date for when the records will be sent but confirmed that the payment has been made. The facility will not be able to deliver the records within the next 24 hours, but they assured that they will include signed certification when the records are ready. The records will be delivered to AMI Health.</span><br>

                <textarea id="editSummary" style="display:none; " rows="10" cols="50">I called the medical records facility and spoke with an employee. The employee informed me that the records request for Paymaneh Baharmast was received and is currently under processing. They could not provide an exact date for when the records will be sent but confirmed that the payment has been made. The facility will not be able to deliver the records within the next 24 hours, but they assured that they will include signed certification when the records are ready. The records will be delivered to AMI Health.</textarea>

                <form id="edit_summary_form" method="post" action="/edit_summary">
                    <input type="hidden" id="editSummaryRecordId" value="391" name="id">
                    <input type="hidden" value="09/13/2024" name="selected_date">
                    <input type="hidden" value="retrieval" name="record_type">
                    <input type="hidden" value="" name="search">
                    <input type="hidden" value="" name="selected_agent"> 
                    <input type="hidden" value="asc" name="sort_order" id="sort_order">
                    <input type="hidden" value="modified_at" name="sort_column" id="sort_column">
                    <input type="hidden" value="" name="page" id="page">
                    <input type="hidden" value="Completed" name="status" id="status">
                    <input type="hidden" id="editedSummary" name="edited_summary">

                    <button style="display: none;" id="edit_Summary_submit" class="btn btn-primary mt-2" type="Save" onclick="submitEditSummaryForm()">Submit</button>
                </form>
            </div>

            <div id="transcript_div" style="overflow: auto;"> <br>
                <span class="h5 fw-bold text-dark">Call Transcript</span><br>
                <button id="ediTranscriptBtn" class="btn btn-primary mt-2" onclick="editTranscriptText(e)" style="border: 1px solid; padding: 1%;"> <i class="fa fa-edit" aria-hidden="true"> Edit </i></button><br>
                <span id="call_transcript" class="p-4 text-muted text-center" style="display: unset;"><span class="timestamp">[00:00.07]</span><br> <span class="bot" style="color:red">BOT:</span> 
                <span class="timestamp">[00:04.82]</span><br> <span class="human" style="color:green">HUMAN:</span>  Recorded for quality assurance.
                <span class="timestamp">[00:08.37]</span><br> <span class="human" style="color:green">HUMAN:</span>  Please listen closely as our menu options have changed.
                <span class="timestamp">[00:08.95]</span><br> BOT_ACTION_START: !STARTING ACTION action_wait WITH PARAMETERS {}!
                <span class="timestamp">[00:08.95]</span><br> BOT_ACTION_FINISH: !ACTION action_wait FINISHED WITH OUTPUT {"success": true}!
                <span class="timestamp">[00:14.17]</span><br> <span class="human" style="color:green">HUMAN:</span>  If this is a hospital, physician office, or urgent patient matter, press nine.
                <span class="timestamp">[00:14.63]</span><br> BOT_ACTION_START: !STARTING ACTION action_wait WITH PARAMETERS {}!
                <span class="timestamp">[00:14.63]</span><br> BOT_ACTION_FINISH: !ACTION action_wait FINISHED WITH OUTPUT {"success": true}!

                <span class="timestamp">[03:04.78]</span><br> <span class="bot" style="color:red">BOT:</span> Goodbye!</span> <br>
                <textarea id="editTranscript" style="display:none; " rows="10" cols="50">&lt;span class="timestamp"&gt;[00:00.07]&lt;/span&gt;&lt;br&gt; &lt;span class="bot" style="color:red"&gt;BOT:&lt;/span&gt;

                &lt;span class="timestamp"&gt;[02:37.73]&lt;/span&gt;&lt;br&gt; &lt;span class="bot" style="color:red"&gt;BOT:&lt;/span&gt; Could you please make sure to send us signed certification along with the records when they are ready?
                &lt;span class="timestamp"&gt;[02:45.85]&lt;/span&gt;&lt;br&gt; &lt;span class="human" style="color:green"&gt;HUMAN:&lt;/span&gt;  Yeah. Sure.
                &lt;span class="timestamp"&gt;[02:46.51]&lt;/span&gt;&lt;br&gt; &lt;span class="bot" style="color:red"&gt;BOT:&lt;/span&gt; Thank you so much for your help.
                &lt;span class="timestamp"&gt;[02:49.10]&lt;/span&gt;&lt;br&gt; &lt;span class="bot" style="color:red"&gt;BOT:&lt;/span&gt; We appreciate your patience while waiting for your call to be answered.
                &lt;span class="timestamp"&gt;[02:55.45]&lt;/span&gt;&lt;br&gt; &lt;span class="bot" style="color:red"&gt;BOT:&lt;/span&gt; Your call is important to us, and we look forward to assisting you shortly.
                &lt;span class="timestamp"&gt;[03:01.10]&lt;/span&gt;&lt;br&gt; &lt;span class="bot" style="color:red"&gt;BOT:&lt;/span&gt; Goodbye!</textarea>

                <form id="edit_transcript_form" method="post" action="/edit_transcript">
                    <input type="hidden" id="editTranscriptRecordId" value="391" name="id">
                    <input type="hidden" value="09/13/2024" name="selected_date">
                    <input type="hidden" value="retrieval" name="record_type">
                    <input type="hidden" value="" name="search">
                    <input type="hidden" value="" name="selected_agent"> 
                    <input type="hidden" value="asc" name="sort_order" id="sort_order">
                    <input type="hidden" value="modified_at" name="sort_column" id="sort_column">
                    <input type="hidden" value="" name="page" id="page">
                    <input type="hidden" value="Completed" name="status" id="status">
                    <input type="hidden" id="editedTranscript" name="edited_transcript">

                    <button style="display: none;" id="edit_Transcript_submit" class="btn btn-primary mt-2" type="Save" onclick="submitEditTranscriptForm()">Submit</button>
                </form>
            </div>

        </div>
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        </div>
  
      </div>
    </div>
  </div>
<!-- latest jquery-->
<script src="{% static 'assets/js/jquery.min.js' %}"></script>

<script>

    // offcanvas details
    // offcanvas details
    function showDetails(log) {
        console.log(log.call_id);

        // hit api to fetch call details
        let mongo_id = log._id;
        let campaign_id = '{{campaign_id}}'
        let call_id = log.call_id;

        $.ajax({
                url: "{% url 'fetch_call_details' %}", // Django URL
                method: "POST",
                data: JSON.stringify({ "mongo_id": mongo_id, "campaign_id": campaign_id ,"call_id":call_id}),
                contentType: "application/json",
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'  // Include CSRF token for security
                },
                success: function(response) {
                    // Show success message using SweetAlert2
                    Swal.fire({
                        icon: 'success',
                        text: response.message
                    });
                    showToast("success", response.message);
                },
                error: function(xhr, status, error) {
                    // Show error message using SweetAlert2
                    Swal.fire({
                        icon: 'error',
                        text: 'Failed to delete contacts: ' + error
                    });
                    showToast("error", "Failed to delete contact! " + error);
                }
            });
        
        
    }

    $(document).ready(function(){
    

    });
</script>
{% endblock %}
